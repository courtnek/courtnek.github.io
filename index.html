<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Encabulator Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-gray-800 py-4">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold">Retro Encabulator Control Panel</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow py-8">
        <div class="container mx-auto px-4">
            <div class="text-center mb-8">
                <h2 id="system-status" class="text-4xl font-light mb-4">System Status: <span id="status-text" class="text-red-400">OFFLINE</span></h2>
                <p class="text-gray-400">Adjust parameters to optimize encabulator performance</p>
                <div class="mt-4">
                    <button id="power-button" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-lg font-semibold">
                        START ENCABULATOR
                    </button>
                </div>
                <div class="mt-2">
                    <span class="text-sm text-gray-400">Efficiency: <span id="efficiency-display" class="text-yellow-400">0%</span></span>
                </div>
            </div>

            <!-- Display Outputs -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto mb-8">
                
                <!-- Waveform Display -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-green-400">Malleable Logarithmic Casing</h3>
                    <div class="bg-black border border-gray-600 p-4 h-32 relative overflow-hidden">
                        <canvas id="waveform" width="400" height="96" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 text-center">
                        Logarithmic Factor: <span id="amplitude-display">0.73</span> | Casing Temp: <span id="freq-display">2847</span> °K
                    </div>
                </div>

                <!-- Status Indicator -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-red-400">Lotus O-Deltoid Main Winding</h3>
                    <div class="flex items-center justify-center h-32">
                        <div id="status-square" class="w-24 h-24 border-2 border-gray-600 bg-red-500"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 text-center">
                        Winding Status: <span id="flux-state">NOMINAL</span>
                    </div>
                </div>

            </div>

            <!-- Spectral Analysis Display -->
            <div class="max-w-4xl mx-auto mb-8">
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-cyan-400">Quantum Spectral Analysis</h3>
                    <div class="bg-black border border-gray-600 p-4 h-40 relative overflow-hidden">
                        <canvas id="spectrum" width="600" height="128" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 text-center grid grid-cols-3 gap-4">
                        <div>Resonance: <span id="resonance-display" class="text-cyan-400">STABLE</span></div>
                        <div>Peak Freq: <span id="peak-freq-display" class="text-yellow-400">2.4 kHz</span></div>
                        <div>Harmonic Dist: <span id="harmonic-display" class="text-green-400">0.03%</span></div>
                    </div>
                </div>
            </div>

            <!-- Waveform Generator & FFT Analysis -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-4xl mx-auto mb-8">
                
                <!-- Waveform Generator Controls -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-orange-400">Harmonic Waveform Generator</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Waveform Type</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="wave-sine" class="bg-orange-600 text-white py-2 px-3 text-xs font-semibold">SINE</button>
                                <button id="wave-square" class="bg-gray-700 hover:bg-orange-600 text-white py-2 px-3 text-xs">SQUARE</button>
                                <button id="wave-triangle" class="bg-gray-700 hover:bg-orange-600 text-white py-2 px-3 text-xs">TRIANGLE</button>
                                <button id="wave-sawtooth" class="bg-gray-700 hover:bg-orange-600 text-white py-2 px-3 text-xs">SAWTOOTH</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Amplitude Modulation</label>
                            <input id="amplitude-slider" type="range" min="10" max="100" value="50" class="w-full">
                            <span id="amplitude-value" class="text-xs text-gray-400">50%</span>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Phase Offset (°)</label>
                            <input id="phase-slider" type="range" min="0" max="360" value="0" class="w-full">
                            <span id="phase-value" class="text-xs text-gray-400">0°</span>
                        </div>
                    </div>
                </div>

                <!-- FFT Frequency Analysis -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-pink-400">FFT Frequency Analysis</h3>
                    <div class="bg-black border border-gray-600 p-4 h-40 relative overflow-hidden">
                        <canvas id="fft-display" width="400" height="128" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 text-center grid grid-cols-3 gap-4">
                        <div>Fundamental: <span id="fundamental-freq" class="text-pink-400">440 Hz</span></div>
                        <div>Harmonics: <span id="harmonic-count" class="text-yellow-400">3</span></div>
                        <div>THD: <span id="thd-display" class="text-green-400">2.1%</span></div>
                    </div>
                </div>

            </div>
            
            <!-- Control Panel Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                
                <!-- Dodge Gears & Bearings -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-green-400">Dodge Spurving Bearings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Bearing Lubrication</label>
                            <input id="flux-slider" type="range" min="0" max="100" value="42" class="w-full">
                            <span id="flux-value" class="text-xs text-gray-400">42%</span>
                        </div>
                        <button id="engage-bearings" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 text-sm" disabled>
                            ENGAGE BEARINGS
                        </button>
                    </div>
                </div>

                <!-- Reliance Electric Motors -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-blue-400">Reliance Electric Motors</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Motor RPM</label>
                            <input id="freq-input" type="number" value="2847" class="w-full bg-gray-800 border border-gray-600 text-white p-2 text-sm">
                        </div>
                        <div class="flex space-x-2">
                            <button id="motor-sync" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-2 text-xs" disabled>SYNC</button>
                            <button id="motor-reset" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-2 text-xs" disabled>RESET</button>
                        </div>
                    </div>
                </div>

                <!-- Hydrocoptic Marzel Vanes -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-purple-400">Hydrocoptic Marzel Vanes</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Vane Angle (°)</label>
                            <div class="flex items-center space-x-2">
                                <button id="pressure-down" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 text-sm">-</button>
                                <span id="pressure-value" class="flex-1 text-center text-lg font-mono">847</span>
                                <button id="pressure-up" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 text-sm">+</button>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="inline-block w-4 h-4 bg-purple-500 rounded-full animate-pulse"></div>
                            <span class="ml-2 text-xs text-gray-400">ACTIVE</span>
                        </div>
                    </div>
                </div>

                <!-- Allen-Bradley Controls -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-yellow-400">Allen-Bradley Controls</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 gap-2">
                            <button id="axis-x" class="bg-gray-700 hover:bg-yellow-600 text-white py-2 text-xs">X</button>
                            <button id="axis-y" class="bg-yellow-600 text-black py-2 text-xs font-semibold">Y</button>
                            <button id="axis-z" class="bg-gray-700 hover:bg-yellow-600 text-white py-2 text-xs">Z</button>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Control Loop Status</label>
                            <div class="w-full bg-gray-700 h-2">
                                <div class="bg-yellow-400 h-2" style="width: 73%"></div>
                            </div>
                            <span class="text-xs text-gray-400">73% Stable</span>
                        </div>
                    </div>
                </div>

                <!-- Ambient Lunar Wane Shaft -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-cyan-400">Ambient Lunar Wane Shaft</h3>
                    <div class="space-y-3">
                        <div class="text-center">
                            <div class="text-2xl font-mono text-cyan-400">1,247,893</div>
                            <div class="text-xs text-gray-400">lunar cycles/min</div>
                        </div>
                        <div class="flex justify-center space-x-1">
                            <div class="w-2 h-8 bg-cyan-400"></div>
                            <div class="w-2 h-6 bg-cyan-400"></div>
                            <div class="w-2 h-10 bg-cyan-400"></div>
                            <div class="w-2 h-4 bg-cyan-400"></div>
                            <div class="w-2 h-7 bg-cyan-400"></div>
                        </div>
                    </div>
                </div>

                <!-- Rockwell Software -->
                <div class="border border-gray-700 p-6 bg-gray-900">
                    <h3 class="text-lg font-semibold mb-4 text-red-400">Rockwell Software</h3>
                    <div class="space-y-3">
                        <button id="system-halt" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 font-semibold" disabled>
                            SYSTEM HALT
                        </button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="system-reset" class="bg-orange-600 hover:bg-orange-700 text-white py-2 text-xs" disabled>RESET</button>
                            <button id="system-backup" class="bg-gray-600 hover:bg-gray-700 text-white py-2 text-xs" disabled>BACKUP</button>
                        </div>
                        <div class="text-center">
                            <div class="inline-block w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="ml-2 text-xs text-gray-400">ALL SYSTEMS NOMINAL</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 py-6">
        <div class="container mx-auto px-4 text-center text-gray-400 text-sm">
            <p>&copy; 2024 Kailean. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Global state
        let fluxValue = 42;
        let frequency = 2847;
        let pressure = 847;
        let currentAxis = 'Y';
        let wavePhase = 0;
        let statusColors = ['bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500', 'bg-purple-500', 'bg-cyan-500'];
        let currentColorIndex = 0;
        let systemRunning = false;
        let efficiency = 0;
        let bearingsEngaged = false;
        let motorSynced = false;
        let spectrumBars = [];
        let spectrumPhase = 0;
        let waveformType = 'sine';
        let waveAmplitudePercent = 50;
        let phaseOffset = 0;
        let fftBars = [];
        let fundamentalFreq = 440;

        // Get canvas and context
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');
        const spectrumCanvas = document.getElementById('spectrum');
        const spectrumCtx = spectrumCanvas.getContext('2d');

        // Initialize spectrum bars
        for (let i = 0; i < 32; i++) {
            spectrumBars.push({
                height: Math.random() * 20 + 5,
                targetHeight: Math.random() * 20 + 5,
                color: getSpectrumColor(i)
            });
        }

        // Initialize FFT bars
        for (let i = 0; i < 64; i++) {
            fftBars.push({
                magnitude: 0,
                targetMagnitude: 0,
                frequency: (i + 1) * 20 // 20Hz per bar
            });
        }

        function getSpectrumColor(index) {
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6'];
            return colors[Math.floor(index / 5) % colors.length];
        }

        // Power button control
        const powerButton = document.getElementById('power-button');
        const statusText = document.getElementById('status-text');
        const efficiencyDisplay = document.getElementById('efficiency-display');

        powerButton.addEventListener('click', function() {
            systemRunning = !systemRunning;
            
            if (systemRunning) {
                this.textContent = 'STOP ENCABULATOR';
                this.className = 'bg-red-600 hover:bg-red-700 text-white px-8 py-3 text-lg font-semibold';
                statusText.textContent = 'ONLINE';
                statusText.className = 'text-green-400';
                enableControls();
            } else {
                this.textContent = 'START ENCABULATOR';
                this.className = 'bg-green-600 hover:bg-green-700 text-white px-8 py-3 text-lg font-semibold';
                statusText.textContent = 'OFFLINE';
                statusText.className = 'text-red-400';
                efficiency = 0;
                bearingsEngaged = false;
                motorSynced = false;
                disableControls();
            }
            updateEfficiency();
        });

        function enableControls() {
            document.getElementById('engage-bearings').disabled = false;
            document.getElementById('motor-sync').disabled = false;
            document.getElementById('motor-reset').disabled = false;
            document.getElementById('system-halt').disabled = false;
            document.getElementById('system-reset').disabled = false;
            document.getElementById('system-backup').disabled = false;
        }

        function disableControls() {
            document.getElementById('engage-bearings').disabled = true;
            document.getElementById('motor-sync').disabled = true;
            document.getElementById('motor-reset').disabled = true;
            document.getElementById('system-halt').disabled = true;
            document.getElementById('system-reset').disabled = true;
            document.getElementById('system-backup').disabled = true;
        }

        function updateEfficiency() {
            if (!systemRunning) {
                efficiency = 0;
            } else {
                // Calculate efficiency based on various factors
                let baseEfficiency = 20;
                if (bearingsEngaged) baseEfficiency += 25;
                if (motorSynced) baseEfficiency += 20;
                if (fluxValue > 60 && fluxValue < 80) baseEfficiency += 15;
                if (pressure > 800 && pressure < 900) baseEfficiency += 10;
                if (frequency > 2500 && frequency < 3000) baseEfficiency += 10;
                
                efficiency = Math.min(100, baseEfficiency);
            }
            
            efficiencyDisplay.textContent = efficiency + '%';
            
            // Change status based on efficiency
            if (efficiency < 30) {
                statusText.textContent = 'CRITICAL';
                statusText.className = 'text-red-400';
            } else if (efficiency < 60) {
                statusText.textContent = 'SUBOPTIMAL';
                statusText.className = 'text-yellow-400';
            } else if (efficiency < 85) {
                statusText.textContent = 'OPTIMAL';
                statusText.className = 'text-green-400';
            } else {
                statusText.textContent = 'MAXIMUM EFFICIENCY';
                statusText.className = 'text-cyan-400';
            }
        }

        // Flux Capacitor Controls
        const fluxSlider = document.getElementById('flux-slider');
        const fluxValueSpan = document.getElementById('flux-value');
        
        fluxSlider.addEventListener('input', function() {
            fluxValue = parseInt(this.value);
            fluxValueSpan.textContent = fluxValue + '%';
            updateStatusSquare();
            updateEfficiency();
            
            // Flux affects motor frequency
            if (systemRunning && fluxValue > 70) {
                frequency = Math.min(3500, frequency + Math.floor(Math.random() * 10));
                document.getElementById('freq-input').value = frequency;
                document.getElementById('freq-display').textContent = frequency;
            }
        });

        // Quantum Oscillator Controls
        const freqInput = document.getElementById('freq-input');
        
        freqInput.addEventListener('input', function() {
            frequency = parseInt(this.value) || 0;
            document.getElementById('freq-display').textContent = frequency;
            updateWaveform();
            updateEfficiency();
            
            // High frequency affects vane angle
            if (systemRunning && frequency > 3000) {
                pressure = Math.min(999, pressure + Math.floor(Math.random() * 20));
                document.getElementById('pressure-value').textContent = pressure;
            }
        });

        // Plasma Conduit Controls
        const pressureValue = document.getElementById('pressure-value');
        const pressureUp = document.getElementById('pressure-up');
        const pressureDown = document.getElementById('pressure-down');

        pressureUp.addEventListener('click', function() {
            if (!systemRunning) return;
            pressure += Math.floor(Math.random() * 50) + 1;
            pressureValue.textContent = pressure;
            updateStatusSquare();
            updateEfficiency();
        });

        pressureDown.addEventListener('click', function() {
            if (!systemRunning) return;
            pressure = Math.max(0, pressure - Math.floor(Math.random() * 50) - 1);
            pressureValue.textContent = pressure;
            updateStatusSquare();
            updateEfficiency();
        });

        // Graviton Stabilizer Controls
        const axisButtons = document.querySelectorAll('[id^="axis-"]');
        
        axisButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Reset all buttons
                axisButtons.forEach(btn => {
                    btn.className = 'bg-gray-700 hover:bg-yellow-600 text-white py-2 text-xs';
                });
                
                // Highlight clicked button
                this.className = 'bg-yellow-600 text-black py-2 text-xs font-semibold';
                currentAxis = this.textContent;
                
                // Non-intuitive effect: changes waveform amplitude
                updateWaveform();
                updateEfficiency();
            });
        });

        // Bearing engagement
        document.getElementById('engage-bearings').addEventListener('click', function() {
            bearingsEngaged = !bearingsEngaged;
            this.textContent = bearingsEngaged ? 'DISENGAGE BEARINGS' : 'ENGAGE BEARINGS';
            this.className = bearingsEngaged ? 
                'w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 text-sm' :
                'w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 text-sm';
            updateEfficiency();
        });

        // Motor controls
        document.getElementById('motor-sync').addEventListener('click', function() {
            motorSynced = true;
            this.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-2 text-xs';
            updateEfficiency();
            
            // Sync affects flux
            fluxValue = Math.min(100, fluxValue + 10);
            document.getElementById('flux-slider').value = fluxValue;
            document.getElementById('flux-value').textContent = fluxValue + '%';
        });

        document.getElementById('motor-reset').addEventListener('click', function() {
            motorSynced = false;
            document.getElementById('motor-sync').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-2 text-xs';
            frequency = 2847;
            document.getElementById('freq-input').value = frequency;
            document.getElementById('freq-display').textContent = frequency;
            updateEfficiency();
        });

        // System controls
        document.getElementById('system-halt').addEventListener('click', function() {
            systemRunning = false;
            powerButton.click(); // Trigger power button
        });

        document.getElementById('system-reset').addEventListener('click', function() {
            // Reset all values
            fluxValue = 42;
            frequency = 2847;
            pressure = 847;
            bearingsEngaged = false;
            motorSynced = false;
            
            document.getElementById('flux-slider').value = fluxValue;
            document.getElementById('flux-value').textContent = fluxValue + '%';
            document.getElementById('freq-input').value = frequency;
            document.getElementById('pressure-value').textContent = pressure;
            document.getElementById('engage-bearings').textContent = 'ENGAGE BEARINGS';
            document.getElementById('engage-bearings').className = 'w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 text-sm';
            
            updateEfficiency();
        });

        // Update Status Square (affected by flux and pressure in weird ways)
        function updateStatusSquare() {
            const statusSquare = document.getElementById('status-square');
            const fluxState = document.getElementById('flux-state');
            
            // Non-intuitive logic: color based on flux + pressure modulo
            const colorIndex = (fluxValue + Math.floor(pressure / 100)) % statusColors.length;
            
            // Remove all color classes
            statusColors.forEach(color => statusSquare.classList.remove(color));
            
            // Add new color
            statusSquare.classList.add(statusColors[colorIndex]);
            
            // Update state text based on weird logic
            const states = ['NOMINAL', 'CRITICAL', 'OPTIMAL', 'UNSTABLE', 'RESONANT', 'CHAOTIC'];
            const stateIndex = Math.floor((fluxValue * pressure) / 10000) % states.length;
            fluxState.textContent = states[stateIndex];
        }

        // Update Waveform (affected by frequency and axis in non-intuitive ways)
        function updateWaveform() {
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, width, height);
            
            // Draw waveform
            ctx.strokeStyle = '#10b981'; // green-500
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const amplitude = document.getElementById('amplitude-display');
            
            // Base parameters affected by axis
            let baseAmplitude = 30;
            let waveFreq = 0.05;
            
            switch(currentAxis) {
                case 'X':
                    baseAmplitude = 15;
                    waveFreq = 0.1;
                    amplitude.textContent = '0.35';
                    break;
                case 'Y':
                    baseAmplitude = 30;
                    waveFreq = 0.05;
                    amplitude.textContent = '0.73';
                    break;
                case 'Z':
                    baseAmplitude = 45;
                    waveFreq = 0.02;
                    amplitude.textContent = '1.24';
                    break;
            }
            
            // Apply amplitude modulation
            const finalAmplitude = baseAmplitude * (waveAmplitudePercent / 100);
            
            // Frequency affects phase shift speed
            const phaseSpeed = frequency / 100000;
            const phaseRad = (phaseOffset * Math.PI) / 180;
            
            for (let x = 0; x < width; x++) {
                let y;
                const t = (x * waveFreq) + wavePhase + phaseRad;
                
                switch(waveformType) {
                    case 'sine':
                        y = height/2 + Math.sin(t) * finalAmplitude;
                        break;
                    case 'square':
                        y = height/2 + (Math.sin(t) > 0 ? 1 : -1) * finalAmplitude;
                        break;
                    case 'triangle':
                        y = height/2 + (2/Math.PI) * Math.asin(Math.sin(t)) * finalAmplitude;
                        break;
                    case 'sawtooth':
                        y = height/2 + (2 * (t % (2*Math.PI)) / (2*Math.PI) - 1) * finalAmplitude;
                        break;
                }
                
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Update phase for animation
            wavePhase += phaseSpeed;
            
            // Update fundamental frequency for FFT
            fundamentalFreq = frequency / 6.5; // Convert motor RPM to audio frequency
        }

        // Update Spectrum Display
        function updateSpectrum() {
            const width = spectrumCanvas.width;
            const height = spectrumCanvas.height;
            
            // Clear canvas
            spectrumCtx.fillStyle = '#000000';
            spectrumCtx.fillRect(0, 0, width, height);
            
            // Update spectrum bars based on system parameters
            const barWidth = width / spectrumBars.length;
            
            for (let i = 0; i < spectrumBars.length; i++) {
                const bar = spectrumBars[i];
                
                // Calculate target height based on system parameters
                let baseHeight = 10;
                
                // Flux affects low frequencies
                if (i < 8) {
                    baseHeight += (fluxValue / 100) * 40;
                }
                
                // Frequency affects mid frequencies
                if (i >= 8 && i < 24) {
                    baseHeight += (frequency / 3500) * 60;
                }
                
                // Pressure affects high frequencies
                if (i >= 24) {
                    baseHeight += (pressure / 1000) * 50;
                }
                
                // Add some randomness and system running effects
                if (systemRunning) {
                    baseHeight += Math.sin(spectrumPhase + i * 0.5) * 15;
                    baseHeight += Math.random() * 10;
                } else {
                    baseHeight *= 0.2;
                }
                
                // Efficiency affects overall amplitude
                baseHeight *= (efficiency / 100) * 0.8 + 0.2;
                
                bar.targetHeight = Math.max(2, Math.min(height - 10, baseHeight));
                
                // Smooth animation
                bar.height += (bar.targetHeight - bar.height) * 0.1;
                
                // Draw bar
                const x = i * barWidth;
                const barHeight = bar.height;
                
                // Create gradient based on height
                const gradient = spectrumCtx.createLinearGradient(0, height, 0, height - barHeight);
                
                if (barHeight > height * 0.8) {
                    gradient.addColorStop(0, '#ef4444'); // red for high
                    gradient.addColorStop(1, '#fbbf24'); // yellow
                } else if (barHeight > height * 0.5) {
                    gradient.addColorStop(0, '#22c55e'); // green for optimal
                    gradient.addColorStop(1, '#06b6d4'); // cyan
                } else {
                    gradient.addColorStop(0, '#3b82f6'); // blue for low
                    gradient.addColorStop(1, '#8b5cf6'); // purple
                }
                
                spectrumCtx.fillStyle = gradient;
                spectrumCtx.fillRect(x + 1, height - barHeight, barWidth - 2, barHeight);
                
                // Add glow effect for high bars
                if (barHeight > height * 0.7) {
                    spectrumCtx.shadowColor = bar.color;
                    spectrumCtx.shadowBlur = 10;
                    spectrumCtx.fillRect(x + 1, height - barHeight, barWidth - 2, barHeight);
                    spectrumCtx.shadowBlur = 0;
                }
            }
            
            // Update spectrum phase for animation
            spectrumPhase += 0.05;
            
            // Update spectrum displays
            updateSpectrumDisplays();
        }

        function updateSpectrumDisplays() {
            const resonanceDisplay = document.getElementById('resonance-display');
            const peakFreqDisplay = document.getElementById('peak-freq-display');
            const harmonicDisplay = document.getElementById('harmonic-display');
            
            // Calculate resonance state
            let resonanceState = 'STABLE';
            if (efficiency > 85) {
                resonanceState = 'OPTIMAL';
                resonanceDisplay.className = 'text-green-400';
            } else if (efficiency < 30) {
                resonanceState = 'CRITICAL';
                resonanceDisplay.className = 'text-red-400';
            } else if (efficiency > 70) {
                resonanceState = 'HARMONIC';
                resonanceDisplay.className = 'text-cyan-400';
            } else {
                resonanceDisplay.className = 'text-cyan-400';
            }
            resonanceDisplay.textContent = resonanceState;
            
            // Calculate peak frequency (affected by motor frequency and flux)
            const peakFreq = ((frequency * fluxValue) / 100000).toFixed(1);
            peakFreqDisplay.textContent = peakFreq + ' kHz';
            
            // Calculate harmonic distortion (affected by pressure and bearings)
            let harmonic = (pressure / 10000) + (bearingsEngaged ? 0.01 : 0.05);
            if (motorSynced) harmonic *= 0.5;
            harmonicDisplay.textContent = harmonic.toFixed(3) + '%';
        }

        function updateFFT() {
            const canvas = document.getElementById('fft-display');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, width, height);
            
            // Calculate FFT-like display based on waveform type and parameters
            const barWidth = width / fftBars.length;
            
            for (let i = 0; i < fftBars.length; i++) {
                const bar = fftBars[i];
                let magnitude = 0;
                
                if (systemRunning) {
                    // Fundamental frequency
                    if (Math.abs(bar.frequency - fundamentalFreq) < 50) {
                        magnitude = 80 * (waveAmplitudePercent / 100);
                    }
                    
                    // Harmonics based on waveform type
                    switch(waveformType) {
                        case 'sine':
                            // Pure sine has only fundamental
                            break;
                        case 'square':
                            // Odd harmonics (3rd, 5th, 7th...)
                            for (let h = 3; h <= 15; h += 2) {
                                if (Math.abs(bar.frequency - (fundamentalFreq * h)) < 30) {
                                    magnitude = (60 / h) * (waveAmplitudePercent / 100);
                                }
                            }
                            break;
                        case 'triangle':
                            // Odd harmonics with 1/h² amplitude
                            for (let h = 3; h <= 11; h += 2) {
                                if (Math.abs(bar.frequency - (fundamentalFreq * h)) < 30) {
                                    magnitude = (40 / (h * h)) * (waveAmplitudePercent / 100);
                                }
                            }
                            break;
                        case 'sawtooth':
                            // All harmonics with 1/h amplitude
                            for (let h = 2; h <= 10; h++) {
                                if (Math.abs(bar.frequency - (fundamentalFreq * h)) < 30) {
                                    magnitude = (50 / h) * (waveAmplitudePercent / 100);
                                }
                            }
                            break;
                    }
                    
                    // Add some system-influenced noise
                    magnitude += (efficiency / 100) * Math.random() * 10;
                    magnitude *= (fluxValue / 100) * 0.8 + 0.2;
                }
                
                bar.targetMagnitude = magnitude;
                bar.magnitude += (bar.targetMagnitude - bar.magnitude) * 0.15;
                
                // Draw bar
                const x = i * barWidth;
                const barHeight = Math.max(1, bar.magnitude);
                
                // Color based on frequency
                let color;
                if (bar.frequency < 500) {
                    color = '#ec4899'; // pink for low freq
                } else if (bar.frequency < 2000) {
                    color = '#f59e0b'; // amber for mid freq
                } else {
                    color = '#06b6d4'; // cyan for high freq
                }
                
                ctx.fillStyle = color;
                ctx.fillRect(x + 1, height - barHeight, barWidth - 2, barHeight);
                
                // Add glow for prominent peaks
                if (barHeight > 40) {
                    ctx.shadowColor = color;
                    ctx.shadowBlur = 8;
                    ctx.fillRect(x + 1, height - barHeight, barWidth - 2, barHeight);
                    ctx.shadowBlur = 0;
                }
            }
            
            updateFFTDisplays();
        }

        function updateFFTDisplays() {
            document.getElementById('fundamental-freq').textContent = Math.round(fundamentalFreq) + ' Hz';
            
            // Count significant harmonics
            let harmonicCount = 0;
            fftBars.forEach(bar => {
                if (bar.magnitude > 10) harmonicCount++;
            });
            document.getElementById('harmonic-count').textContent = harmonicCount;
            
            // Calculate THD based on waveform type
            let thd = 0;
            switch(waveformType) {
                case 'sine': thd = 0.1; break;
                case 'square': thd = 48.3; break;
                case 'triangle': thd = 12.1; break;
                case 'sawtooth': thd = 25.7; break;
            }
            thd *= (waveAmplitudePercent / 100);
            thd += (100 - efficiency) / 50; // System efficiency affects distortion
            document.getElementById('thd-display').textContent = thd.toFixed(1) + '%';
        }

        // Animation loop
        function animate() {
            if (systemRunning) {
                updateWaveform();
                updateSpectrum();
                updateFFT();
            } else {
                updateSpectrum(); // Still show spectrum when offline, just dimmed
                updateFFT(); // Show FFT even when offline
            }
            requestAnimationFrame(animate);
        }

        // Status square flashing
        function flashStatusSquare() {
            const statusSquare = document.getElementById('status-square');
            
            // More flashing when system is running and efficiency is low
            let flashChance = systemRunning ? (efficiency < 50 ? 0.3 : 0.1) : 0.05;
            
            if (Math.random() < flashChance) {
                statusSquare.style.opacity = '0.3';
                setTimeout(() => {
                    statusSquare.style.opacity = '1';
                }, 100);
            }
        }

        // Start animations
        animate();
        setInterval(flashStatusSquare, 500);

        // Initialize displays
        updateStatusSquare();
        updateWaveform();
        updateSpectrum();
        updateFFT();
        updateEfficiency();
        disableControls();
    </script>
</body>
</html>
